---
name: consistency-check
description: requirements→specs→code→test の一貫性検証ガイド。/review でPRをレビューするとき、/implement のセルフチェック時、ドキュメントとコードの乖離を確認するときに使用する。
commands: ["/review", "/implement"]
---

# 一貫性検証ガイド

## 検証の5層

### Layer 0: milestones → requirements

- マイルストーンのタスク一覧に記載された全タスクに requirements ファイルが存在するか
- 優先度の高いタスクから実装が進んでいるか
- マイルストーンのスコープ外の作業（マイルストーンに記載のないタスクの実装）が混入していないか
- マイルストーンの完了条件チェックリストの進捗

### Layer 1: requirements → specs

- requirements のビジネスルール（BR-N）が specs のルール一覧に反映されているか
- requirements の受け入れ基準が specs の API 仕様・ドメインモデルで実現可能か
- 仕様変更の場合、変更区分セクション（ADDED / MODIFIED / REMOVED）が specs に反映されているか
- 出典の追跡: specs のルールから元の requirements を辿れるか

### Layer 2: specs → code

- API 仕様のエンドポイント・リクエスト・レスポンスがコードと一致するか
- ドメインモデルのエンティティ・値オブジェクトがコードに対応するか
- 不変条件がコードで強制されているか（DB 制約だけでなくドメイン層で）
- ステータス遷移がコードで正しく実装されているか

### Layer 3: code → test

- 受け入れ基準に対応するテストが存在するか
- 正常系・異常系の両方がテストされているか
- テスト名から受け入れ基準との対応が読み取れるか

### Layer 4: 横断的整合性

- 新しい用語が docs/project.md の用語集に追加されているか
- 技術判断がある場合、ADR として記録されているか
- コーディング規約・アーキテクチャ方針に準拠しているか

## 問題の重大度

| 重大度 | 定義 | 例 | 対応 |
|---|---|---|---|
| Critical | 仕様とコードが矛盾 | API レスポンス形式が仕様と異なる | マージブロック |
| Important | 仕様の一部が未実装 | 異常系の処理が未実装 | 修正を要求 |
| Minor | 品質・保守性の問題 | テスト名が曖昧 | 提案として記録 |

## レビューコメントの書き方

### 構造

```
[重大度] 概要

詳細な説明（なぜ問題か）
提案する修正案（あれば）
```

### 良い指摘の条件

- **具体的**: ファイル名・行番号・該当コードを示す
- **根拠がある**: どのルール・仕様に違反しているかを示す
- **修正案がある**: 問題だけでなく解決策を提案する
- **重大度が明確**: Critical / Important / Minor を示す

<!-- 以下が PR チェックリストの正規定義。他ファイル（04-branching.md 等）からはここを参照する -->

## PR チェックリスト

PR を出す前に以下を確認する:

- [ ] 新機能の場合: docs/requirements/ に要件ファイルが含まれている
- [ ] specs の変更がある場合: requirements に変更経緯が記録されている
- [ ] 技術判断がある場合: docs/adr/ に記録されている
- [ ] テストが含まれている
- [ ] 要件の受け入れ基準がテストでカバーされている
- [ ] 新しい用語がある場合: docs/project.md の用語集に追加されている
- [ ] マイルストーンが設定されている場合: タスクがマイルストーンのタスク一覧に含まれている
