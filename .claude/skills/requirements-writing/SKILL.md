---
name: requirements-writing
description: 良い要件定義の書き方ガイド。ユーザーストーリー・受け入れ基準・ビジネスルールの品質を高める判断基準と技法。/create-requirement の実行時、要件のレビュー時、受け入れ基準の妥当性を判断するときに使用する。
commands: ["/create-requirement", "/review"]
---

# 良い要件の書き方

## ユーザーストーリー

### 形式

「{{ROLE}}として、{{ACTION}}したい。なぜなら{{REASON}}だから。」

### 品質基準（INVEST）

- **Independent**: 他のストーリーに依存しない
- **Negotiable**: 詳細は交渉可能
- **Valuable**: ユーザーに価値を提供する
- **Estimable**: 見積もり可能な粒度
- **Small**: 1イテレーションで完了できる
- **Testable**: テスト可能

### 良い例と悪い例

- ❌「ユーザーとして、データを管理したい」→ 曖昧。何のデータを、どう管理するのか不明
- ✅「管理者として、招待メールを再送したい。なぜなら期限切れの招待に対応できないから」

## 受け入れ基準

### テスト可能にする4原則

1. **主語を明確にする**: 「ユーザーが」「システムが」
2. **観測可能な結果を書く**: 「表示される」「保存される」「メールが送信される」
3. **境界値を含める**: 「3回まで」「100文字以内」
4. **曖昧な形容詞を避ける**: ❌「速い」→ ✅「200ms以内」

### 形式

```
- [ ] {{主語}}が{{操作}} → {{観測可能な期待結果}}
```

### 正常系と異常系の両方を含める

- **正常系**: ハッピーパス + 主要なバリエーション
- **異常系**: バリデーションエラー、権限不足、リソース未存在、競合状態

異常系を忘れがち。最低限「入力が不正」「権限なし」「対象が存在しない」の3パターンを検討する。

## ビジネスルール

- 番号を振って一意に参照可能にする（BR-1, BR-2...）
- 1ルール1文で書く。複合条件は分割する
- 例外がある場合は明示する
- specs やテストから「BR-1」で参照できるようにする

### 例

```
BR-1: 招待メールの有効期限は送信から72時間とする
BR-2: 1つのメールアドレスに対する同時有効な招待は1件までとする
BR-3: BR-2 の例外として、管理者は有効期限内でも再送できる（既存の招待は無効化される）
```

## セキュリティ観点の受け入れ基準

機能によっては、以下のセキュリティ観点を異常系の受け入れ基準に含める:

- **認証・認可**: 未認証ユーザー、権限不足のユーザーのアクセス
- **入力検証**: 不正な入力値、SQLインジェクション、XSS の防止
- **データ保護**: 他ユーザーのデータへの不正アクセス防止（IDOR）
- **レート制限**: ブルートフォース攻撃の防止（ログイン、API等）

全てを毎回書く必要はない。該当する機能（認証、ユーザーデータ操作、外部入力処理等）で検討する。

## スコープ判断

### 分割すべきサイン

- ユーザーストーリーが3つ以上ある
- 受け入れ基準が20項目を超える
- 複数のドメインにまたがる

### 分割の方法

- ユーザーストーリー単位で分割する
- CRUD のうち一部だけを先行する（例: 参照系を先に実装）
- 正常系と異常系を分けて段階的に実装する

### 分割後の依存管理

- 分割した要件間に依存がある場合、フロントマターの `depends_on` に相互の TASK_ID を記載する
- 依存先の要件が `implemented` 状態でない場合、/implement の前提確認で検出される
- 分割の単位は「独立してテスト可能な単位」を基準にする
