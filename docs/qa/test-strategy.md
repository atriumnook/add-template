# テスト戦略

## 方針

<!-- このプロジェクトのテストに対する基本姿勢 -->

テストはAIが生成し、人間がレビューする。テストの存在自体がコードの仕様書として機能する。

## テストピラミッド

| 層             | 対象                             | カバレッジ目標       | 実行タイミング        |
| -------------- | -------------------------------- | -------------------- | --------------------- |
| ユニットテスト | ビジネスロジック・ドメインモデル | {{TARGET}}% 以上     | PR時（CI必須）        |
| 統合テスト     | DB・外部API境界                  | クリティカルパス     | PR時（CI必須）        |
| E2E テスト     | ユーザーフロー全体               | クリティカルパス100% | マージ後 / デプロイ前 |

## テスト分類と責任範囲

### ユニットテスト

- **対象**: domain/ 層のエンティティ・値オブジェクト・ユースケース
- **外部依存**: 全てモック化
- **命名**: 日本語で「何をテストしているか」を明記
- **配置**: tests/ またはソースと同階層（コロケーション）

### 統合テスト

- **対象**: infrastructure/ 層のリポジトリ実装・外部サービス連携
- **外部依存**: テスト用DB（またはインメモリ）を使用
- **配置**: tests/integration/

### E2E テスト

- **対象**: ユーザーの主要操作フロー
- **詳細**: docs/qa/e2e-guidelines.md を参照
- **配置**: e2e/

## CI 実行ポリシー

| イベント      | 実行するテスト        | 失敗時の挙動            |
| ------------- | --------------------- | ----------------------- |
| PR 作成・更新 | ユニット + 統合       | マージブロック          |
| main マージ   | ユニット + 統合 + E2E | デプロイブロック + 通知 |
| デプロイ後    | スモークテスト        | ロールバック検討 + 通知 |

## リグレッションテスト

- 全自動で実行する
- 失敗時はマージ/デプロイをブロックする
- 新機能追加時に既存テストが壊れた場合、仕様変更なのかバグなのかを判断してから修正する
